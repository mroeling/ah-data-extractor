<template>
  <section class="nest-heatmap" ref="rootEl">
    <h2>Hoornaarnest – Heatmap Analyse</h2>

    <form submit.trigger="run($event)" class="nh-form">
      <!-- Bestanden -->
      <fieldset class="nh-fieldset">
        <legend>Data-invoer</legend>

        <label class="nh-label">
          <span>Registraties (shapefile .shp, RD New)</span>
          <input
            type="file"
            accept=".shp"
            change.trigger="shpFileChanged($event.target.files[0])">
        </label>

        <label class="nh-label">
          <span>Of GeoJSON (WGS84) met registraties</span>
          <input
            type="file"
            accept=".json,.geojson"
            change.trigger="geoJsonFileChanged($event.target.files[0])">
        </label>

        <label class="nh-label">
          <span>Attribuuttabel (.dbf, zelfde shapefile)</span>
          <input
            type="file"
            accept=".dbf"
            change.trigger="dbfFileChanged($event.target.files[0])">
        </label>

        <p class="nh-help" if.bind="shapefileInfo">${shapefileInfo}</p>

        <label class="nh-label">
          <span>Basiskaart</span>
          <select value.bind="baseSource">
            <option value="online">Online (Carto rastertiles/voyager)</option>
            <option value="upload">Handmatige upload</option>
          </select>
        </label>
        <p class="nh-help" if.bind="baseSource === 'online'">
          We downloaden automatisch de Carto Voyager OSM-tegelset: https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png (met OSM/CARTO-attributie in de UI opnemen).
        </p>
        <label class="nh-label" if.bind="baseSource === 'upload'">
          <span>Eigen kaart (zonder waarnemingen)</span>
          <input
            type="file"
            accept="image/*"
            change.trigger="baseFileChanged($event.target.files[0])">
        </label>
      </fieldset>

      <fieldset class="nh-fieldset">
        <legend>Kaart-extents (RD New of WGS84)</legend>
        <p class="nh-help">
          Automatisch gevuld vanuit de shapefile; pas aan als de basiskaart een andere uitsnede heeft. Bij OSM/WebMercator screenshots: kies WGS84 en vul hoeken in graden, we projecteren automatisch naar WebMercator.
        </p>
        <label class="nh-label">
          <span>Kaart-coördinaten referentiesysteem</span>
          <select value.bind="boundsCrs">
            <option value="rd">RD New (EPSG:28992)</option>
            <option value="wgs84">WGS84 / WebMercator (graden, bij OSM)</option>
          </select>
        </label>
        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>minX (west)</span>
            <input type="number" step="any" value.bind="boundsInput.minX">
          </label>
          <label class="nh-label nh-inline">
            <span>minY (zuid)</span>
            <input type="number" step="any" value.bind="boundsInput.minY">
          </label>
        </div>
        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>maxX (oost)</span>
            <input type="number" step="any" value.bind="boundsInput.maxX">
          </label>
          <label class="nh-label nh-inline">
            <span>maxY (noord)</span>
            <input type="number" step="any" value.bind="boundsInput.maxY">
          </label>
        </div>
      </fieldset>

      <fieldset class="nh-fieldset">
        <legend>Periodefilter (standaard: dit jaar)</legend>
        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Van (YYYY-MM-DD)</span>
            <input type="date" value.bind="fromDate">
          </label>
          <label class="nh-label nh-inline">
            <span>Tot en met (YYYY-MM-DD)</span>
            <input type="date" value.bind="toDate">
          </label>
        </div>
        <p class="nh-help">Alleen registraties binnen deze periode worden gebruikt.</p>
      </fieldset>

      <fieldset class="nh-fieldset">
        <legend>Ecologische scores</legend>

        <label class="nh-label">
          <span>Score bos (treeScore)</span>
          <input
            type="number"
            step="0.05"
            value.bind="config.treeScore">
        </label>

        <label class="nh-label">
          <span>Score gras (grassScore)</span>
          <input
            type="number"
            step="0.05"
            value.bind="config.grassScore">
        </label>

        <label class="nh-label">
          <span>Bonus nabij water (nearWaterBonus)</span>
          <input
            type="number"
            step="0.05"
            value.bind="config.nearWaterBonus">
        </label>

        <label class="nh-label">
          <span>Gewicht per waarneming (wObs)</span>
          <input
            type="number"
            min="0"
            max="1"
            step="0.01"
            value.bind="config.wObs">
        </label>

        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Boskleur R</span>
            <input type="number" min="0" max="255" value.bind="config.treeColor.r">
          </label>
          <label class="nh-label nh-inline">
            <span>G</span>
            <input type="number" min="0" max="255" value.bind="config.treeColor.g">
          </label>
          <label class="nh-label nh-inline">
            <span>B</span>
            <input type="number" min="0" max="255" value.bind="config.treeColor.b">
          </label>
        </div>

        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Bos tolerantie</span>
            <input type="number" min="0" max="128" step="1" value.bind="config.treeTolerance">
          </label>
          <label class="nh-label nh-inline">
            <span>Gras tolerantie</span>
            <input type="number" min="0" max="128" step="1" value.bind="config.grassTolerance">
          </label>
          <label class="nh-label nh-inline">
            <span>Water tolerantie</span>
            <input type="number" min="0" max="128" step="1" value.bind="config.waterTolerance">
          </label>
        </div>

        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Graskleur R</span>
            <input type="number" min="0" max="255" value.bind="config.grassColor.r">
          </label>
          <label class="nh-label nh-inline">
            <span>G</span>
            <input type="number" min="0" max="255" value.bind="config.grassColor.g">
          </label>
          <label class="nh-label nh-inline">
            <span>B</span>
            <input type="number" min="0" max="255" value.bind="config.grassColor.b">
          </label>
        </div>

        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Waterkleur R</span>
            <input type="number" min="0" max="255" value.bind="config.waterColor.r">
          </label>
          <label class="nh-label nh-inline">
            <span>G</span>
            <input type="number" min="0" max="255" value.bind="config.waterColor.g">
          </label>
          <label class="nh-label nh-inline">
            <span>B</span>
            <input type="number" min="0" max="255" value.bind="config.waterColor.b">
          </label>
        </div>
      </fieldset>

      <fieldset class="nh-fieldset">
        <legend>Afstanden & smoothing</legend>

        <label class="nh-label">
          <span>Max. afstand van waarneming (pixels)</span>
          <div class="nh-row">
            <input
              type="range"
              min="10"
              max="400"
              step="5"
              value.bind="config.coveragePx">
            <input
              type="number"
              min="1"
              max="1000"
              step="1"
              value.bind="config.coveragePx">
          </div>
        </label>

        <label class="nh-label">
          <span>Smoothing radius (pixels)</span>
          <input
            type="number"
            step="1"
            min="1"
            value.bind="config.smoothPixels">
        </label>

        <label class="nh-label">
          <span>Iso-scores (waarden tussen 0 en 1, komma-gescheiden)</span>
          <input
            type="text"
            value.bind="isoString">
        </label>
      </fieldset>

      <fieldset class="nh-fieldset">
        <legend>Visualisatie</legend>

        <div class="nh-row">
          <label class="nh-label nh-inline">
            <span>Heatmap kleur R</span>
            <input
              type="number"
              min="0"
              max="255"
              value.bind="config.heatColor.r">
          </label>

          <label class="nh-label nh-inline">
            <span>G</span>
            <input
              type="number"
              min="0"
              max="255"
              value.bind="config.heatColor.g">
          </label>

          <label class="nh-label nh-inline">
            <span>B</span>
            <input
              type="number"
              min="0"
              max="255"
              value.bind="config.heatColor.b">
          </label>
        </div>

        <label class="nh-label">
          <span>Minimale overlay alpha (0–255)</span>
          <input
            type="number"
            min="0"
            max="255"
            value.bind="config.minAlpha">
        </label>

        <label class="nh-label">
          <span>Gamma (0–2, lager = meer contrast)</span>
          <input
            type="number"
            step="0.1"
            value.bind="config.gamma">
        </label>
      </fieldset>

      <button type="submit" class="nh-button" disabled.bind="!canRun || isBusy">
        Bereken heatmap
      </button>
    </form>

    <section class="nh-fieldset nh-converter">
      <legend>RD ➜ WGS84 converter (eenmalige pre-export)</legend>
      <p class="nh-help">
        Gebruik dit om je RD shapefile naar WGS84 GeoJSON te exporteren. Upload de .shp (en optioneel de .dbf voor datums) en klik op export.
      </p>
      <div class="nh-row">
        <label class="nh-label nh-inline">
          <span>Shapefile (.shp)</span>
          <input type="file" accept=".shp" change.trigger="shpFileChanged($event.target.files[0])">
        </label>
        <label class="nh-label nh-inline">
          <span>DBF (optioneel)</span>
          <input type="file" accept=".dbf" change.trigger="dbfFileChanged($event.target.files[0])">
        </label>
      </div>
      <button
        type="button"
        class="nh-button"
        disabled.bind="!canExport || isBusy"
        click.trigger="exportShpToGeoJson()">
        Exporteer naar WGS84 GeoJSON
      </button>
    </section>

    <section class="nh-results" if.bind="heatmapUrl || isoUrl">
      <h3>Resultaten</h3>
      <p class="nh-help">Kaartbron: Carto Voyager (OSM-data, © OpenStreetMap-bijdragers / © CARTO).</p>

      <div class="nh-result-grid">
        <div class="nh-result-item" if.bind="heatmapUrl">
          <h4>Kale heatmap</h4>
          <img src.bind="heatmapUrl" alt="Nest heatmap">
        </div>

        <div class="nh-result-item" if.bind="isoUrl">
          <h4>Heatmap met iso-lijnen</h4>
          <img src.bind="isoUrl" alt="Nest heatmap met iso-scores">
        </div>
      </div>
    </section>
  </section>
</template>
